function initMp3Player(){audio.crossOrigin="anonymous",audio.src=tracks[0].src,audio.controls=!0,audio.loop=!0,audio.autoplay=!0,$("#audio_box").html(audio),context=new AudioContext,analyser=context.createAnalyser(),analyser.fftSize=2048,source=context.createMediaElementSource(audio),source.connect(analyser),analyser.connect(context.destination),render()}function render(){requestAnimationFrame(render),renderer.render(scene,camera),autoRotate&&spinObj(scene,"y",.001),fbc_array=new Uint8Array(64),analyser.getByteFrequencyData(fbc_array),$.each(bars,function(e,o){fbc_array[e]/50>0&&setBarHeight(o,fbc_array[e]/50,!1)})}function CreatePlane(e,o,t,n,a){var i=new THREE.PlaneGeometry(e,o,t,n),r=new THREE.MeshBasicMaterial({color:a});return new THREE.Mesh(i,r)}function CreateBar(e,o){var t=new THREE.BoxGeometry(o.l,o.h,o.w),n=new THREE.MeshPhongMaterial({color:"#5599DD"}),a=new THREE.Mesh(t,n);return a.position.set(e.x,e.y,e.z),a}function setBarHeight(e,o,t){t?e.scale.y+=o:e.scale.y=o}function setZoomLevel(e){var o=e-camera.position.z;camera.translateZ(o)}function Rads2Degs(e){return 180*e/Math.PI}function Degs2Rads(e){return e*Math.PI/180}function getDistance(e,o){var t=o.x-e.x,n=o.y-e.y,a=Math.sqrt(t*t+n*n);return a}function spinObj(e,o,t){"X"==o.toUpperCase()?e.rotateX(t):"Y"==o.toUpperCase()?e.rotateY(t):"Z"==o.toUpperCase()&&e.rotateZ(t)}function onWindowResize(){windowHalfX=window.innerWidth/2,windowHalfY=window.innerHeight/2,camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}var debug=!1,output=$("#output"),scene,camera,renderer,autoRotate=!debug,bars=[],tracks=[{name:"Do The Math",src:"dothemath.mp3"},{name:"Cinema",src:"Cinema.mp3"},{name:"HRH Radio",src:"http://listen.djcmedia.com/hrhradiohigh"}],audio=new Audio,source,context,analyser,fbc_array,held,startPos,lastPos,mouse=new THREE.Vector2;$(function(){$(window).on("load",initMp3Player),camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),scene=new THREE.Scene,scene.rotateY(Math.PI),renderer=new THREE.WebGLRenderer,renderer.setClearColor(1118481),renderer.setSize(window.innerWidth,window.innerHeight);var e=new THREE.PointLight(16711680,1,75);e.position.set(-40,0,-30),scene.add(e);var o=new THREE.PointLight(16711680,1,75);o.position.set(40,0,-30),scene.add(o);var t=new THREE.PointLight(16711680,1,75);t.position.set(-40,0,30),scene.add(t);var n=new THREE.PointLight(16711680,1,75);n.position.set(40,0,30),scene.add(n);var a=new THREE.AmbientLight(7829367);scene.add(a);new THREE.Vector3(0,0,0);camera.position.x=0,camera.position.y=45,camera.position.z=0;for(var r=0;64>r;r++){var s=CreateBar({x:r+r-64,y:0,z:0},{l:1,h:10,w:2});bars.push(s),setBarHeight(s,.1,!1),scene.add(s)}setZoomLevel(-100);var c=CreatePlane(300,300,1,1,"#111111");c.position.set(0,0,0),c.rotation.set(-Math.PI/2,0,0),scene.add(c);var l=new THREE.AxisHelper(5);camera.lookAt(l.position),output.append(renderer.domElement),renderer.render(scene,camera),$("#autoRotate").change(function(){autoRotate=!autoRotate}),$.each(tracks,function(e,o){$("#trackSelection").append("<option value='"+e+"'>"+o.name+"</option>")}),$("#trackSelection").change(function(e){fbc_array=new Uint8Array(64),$(audio).prop("src",tracks[e.target.value].src)}),$(output).mousedown(function(e){held=!0,output.addClass("grab"),d=Array(e.offsetX,e.offsetY)}).bind("mouseup mouseleave",function(){held=!1,output.removeClass("grab")}),$(output).on("mousemove",function(e){if(e.preventDefault(),held){startPos=Array(e.offsetX,e.offsetY);{var o=(d[0]-startPos[0])/50;Math.abs(Math.round(100*Rads2Degs(scene.rotation.x))/100)}scene.rotateY(-o/4),d=startPos}else mouse.x=event.clientX/window.innerWidth*2-1,mouse.y=2*-(event.clientY/window.innerHeight)+1}),$(output).on("touchstart",function(e){held=!0,d=Array(e.originalEvent.touches[0].screenX,e.originalEvent.touches[0].screenY),2===e.originalEvent.touches.length&&(E=getDistance(new THREE.Vector2(e.originalEvent.touches[0].screenX,e.originalEvent.touches[0].screenY),new THREE.Vector2(e.originalEvent.touches[1].screenX,e.originalEvent.touches[1].screenY)))}).bind("touchend touchcancel",function(){held=!1});var m,d,E;$(output).on("touchmove",function(e){if(e.preventDefault(),held)if(1===e.originalEvent.touches.length){autoRotate=!1,m=Array(e.originalEvent.touches[0].screenX,e.originalEvent.touches[0].screenY);{var o=(d[0]-m[0])/50;Math.abs(Math.round(100*Rads2Degs(scene.rotation.x))/100)}scene.rotateY(-o/4),d=m}else if(2===e.originalEvent.touches.length){var n=Array(e.originalEvent.touches[0].screenX,e.originalEvent.touches[0].screenY),a=Array(e.originalEvent.touches[1].screenX,e.originalEvent.touches[1].screenY),i=new THREE.Vector2(n[0],n[1]),r=new THREE.Vector2(a[0],a[1]),s=getDistance(i,r),c=(s-E)/5;camera.position.z-c<150&&camera.position.z-c>10&&camera.translateZ(-c),E=s}}),window.addEventListener("resize",onWindowResize,!1)});